---
title: "Synechococcus Proteome Power Law Global Error Model (PLGEM)"
author: "Cara Schiksnis"
date: "5/23/23"
output: html_notebook
---

### Description: PLGEM to obtain lists of significantly differentially abundant proteins in pairwise comparisons

**Load packages:**
```{r, results='hide', message=FALSE, warning=FALSE}
if (!require("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
BiocManager::install("Biobase")
BiocManager::install("plgem")
if(!require(dplyr)){install.packages("dplyr")}
if(!require(ggplot2)){install.packages("ggplot2")}
if(!require(writexl)){install.packages("writexl")}

library(BiocManager)
library(Biobase)
library(plgem)
library(dplyr)
library(ggplot2)
library(writexl)
```

#### YX04-1:

**27Lvs27R (Fe limitation at thermal optimum)**
```{r, message=FALSE, warning=FALSE}
## load and prep data in proper format for PLGEM
oo <- read.csv("oo_protein_data.csv", check.names = FALSE) 

oo_27L27R <- oo[,c(1:4,8:10,14:20)] # df with only the samples in the current pairwise comparison
oo_27L27R <- oo_27L27R[rowSums(oo_27L27R[,2:7])>0,] # remove proteins that have 0 abundance across all samples in pairwise comparison

# exprsFile
exprsFile <- oo_27L27R[,c(1:7)] # select KO and all sample columns only
row.names(exprsFile) <- exprsFile$KO # KOs as row names
exprsFile$KO <- NULL

# exprs
exprs <- as.matrix(exprsFile) # convert to matrix 

# p data
pData <- read.csv("Pdata_PLGEM.csv") 
pData <- pData[c(1:3,7:9),] # include only samples in pairwise comparison
pData$Temperature <- as.character(pData$Temperature)
row.names(pData) <- pData$Sample # samples as rows
pData$Sample <- NULL

all(rownames(pData)==colnames(exprs)) # check

# put files in right format for model building
experimentData <- new("MIAME", name="Cara Schiksnis", lab="Hutchins Lab", 
                      title="YX04-1 Warming/ Fe Limitation", abstract="Proteomics analysis using PLGEM")
phenoData <- new("AnnotatedDataFrame", data=pData) 
expressionset <- ExpressionSet(assayData=exprs, phenoData=phenoData, experimentData=experimentData)

## model building
fit_27L <- plgem.fit(data=expressionset, covariate="Iron", fitCondition="L", 
                     p=10, q=0.5, trimAllZeroRows=TRUE, zeroMeanOrSD="trim", 
                     plot.file=FALSE, fittingEval=TRUE, verbose=TRUE)

fit_27R <- plgem.fit(data=expressionset, covariate="Iron", fitCondition="R", 
                     p=10, q=0.5, trimAllZeroRows=TRUE, zeroMeanOrSD="trim", 
                     plot.file=FALSE, fittingEval=TRUE, verbose=TRUE)

# compute observed signal-to-noise ratios
obsSTN <- plgem.obsStn(data=expressionset, 
                       covariate="Iron", baselineCondition="R", 
                       plgemFit=fit_27L, verbose=TRUE)

# compute resampled STN ratios
set.seed(123) 
resampledSTN <- plgem.resampledStn(data=expressionset,  
                                   covariate="Iron", baselineCondition="R", 
                                   plgemFit=fit_27L,
                                   iterations=2000, verbose=TRUE)

# compute P values 
pValues <- plgem.pValue(observedStn=obsSTN, plgemResampledStn=resampledSTN, verbose=TRUE)

# detection of differentially abundant proteins 
DEGlist <- plgem.deg(observedStn=obsSTN, plgemPval=pValues, 
                         delta=0.01, verbose=TRUE) 

# EXPORT results to directory
plgem.write.summary(DEGlist, verbose=TRUE)

# load in proteins and their p values (output from PLGEM above)
allPvalues <- read.csv("_stn_p-value.csv")
colnames(allPvalues) <- c("KO", "STN", "Pvalue")


# plot p values histogram 
allPvalues %>% 
  ggplot(aes(Pvalue)) + 
  geom_histogram(binwidth = 0.01, 
                 boundary = 0.5, 
                 fill = "darkblue",
                 colour = "white") +
  xlab("p-value") +
  ylab("Frequency") +
  labs(title = "P value distribution") +
  theme_minimal()

# make df with abundance data and p values for all proteins
data_27L <- merge(allPvalues, oo_27L27R, by = "KO")

# calculate log2 fold change
data_27L_fc <- data_27L[,4:9] # df to hold just abundance data for now
colnames(data_27L_fc) <- c("27L1_log", "27L2_log", "27L3_log", "27R1_log", "27R2_log", "27R3_log") # differentiate between log and non log data
data_27L_fc <- log2(data_27L_fc+1) # log transform
data_27L_fc <- cbind(data_27L, data_27L_fc) # combine log transformed data back with p values and annotations 

# calculate and add new columns for average abundances, log2 fold change, and -log10Pvalue
data_27L_fc$Pvalue[data_27L_fc$Pvalue == 0] <- 0.000001 # so it doesn't calculate "inf" for -log10Pvalue

data_27L_fc <- data_27L_fc %>% 
  dplyr::group_by(KO) %>% 
  dplyr::mutate(mean_control = mean(c(`27R1`, `27R2`, `27R3`)),
                mean_treatment= mean(c(`27L1`, `27L2`, `27L3`)),
                mean_control_log = mean(c(`27R1_log`, `27R2_log`, `27R3_log`)),
                mean_treatment_log= mean(c(`27L1_log`, `27L2_log`, `27L3_log`)),
                log_fc = mean_treatment_log - mean_control_log,
                log_pval = -1*log10(Pvalue),
                Expression = case_when(log_fc >= 1 && log_pval >= 2 ~ 'Upregulated',
                                       log_fc <= -1 && log_pval >=2 ~ 'Downregulated',
                                       TRUE ~ 'Unchanged'))

# filter significant DAPs 
data_27L_DAPs <- data_27L_fc %>%
  filter(log_pval >= 2 & (log_fc >= 1 | log_fc <= -1))  #P < 0.01 and log fc > 1 or -1 (doubling)

write.csv(data_27L_DAPs, "YX_27Lvs27R_DAPs_data.csv", row.names = FALSE) 
#write_xlsx(data_27L_DAPs, "YX_27Lvs27R_DAPs_data.xlsx")
```


**30Lvs30R (Fe limitation at supra optimum temperature)**
```{r, message=FALSE, warning=FALSE}
## load and prep data in proper format required for PLGEM
oo <- read.csv("oo_protein_data.csv", check.names = FALSE) 

oo_30L30R <- oo[,c(1,5:7,11:13,14:20)] # df with only the samples in the current pairwise comparison
oo_30L30R <- oo_30L30R[rowSums(oo_30L30R[,2:7])>0,] # remove proteins that have 0 abundance across all samples in pairwise comparison

# exprsFile
exprsFile <- oo_30L30R[,c(1:7)] # select KO and all sample columns only
row.names(exprsFile) <- exprsFile$KO # KOs as row names
exprsFile$KO <- NULL

# exprs
exprs <- as.matrix(exprsFile) # convert to matrix 

# p data
pData <- read.csv("Pdata_PLGEM.csv")
pData <- pData[c(4:6,10:12),] # include only samples in pairwise comparison
pData$Temperature <- as.character(pData$Temperature)
row.names(pData) <- pData$Sample # samples as rows
pData$Sample <- NULL

all(rownames(pData)==colnames(exprs)) # check

# put files in right format for model building
experimentData <- new("MIAME", name="Cara Schiksnis", lab="Hutchins Lab", 
                      title="YX04-1 Warming/ Fe Limitation", abstract="Proteomics analysis using PLGEM")
phenoData <- new("AnnotatedDataFrame", data=pData) 
expressionset <- ExpressionSet(assayData=exprs, phenoData=phenoData, experimentData=experimentData)

## model building
fit_30L <- plgem.fit(data=expressionset, covariate="Iron", fitCondition="L", 
                     p=10, q=0.5, trimAllZeroRows=TRUE, zeroMeanOrSD="trim", 
                     plot.file=FALSE, fittingEval=TRUE, verbose=TRUE)

fit_30R <- plgem.fit(data=expressionset, covariate="Iron", fitCondition="R", 
                     p=10, q=0.5, trimAllZeroRows=TRUE, zeroMeanOrSD="trim", 
                     plot.file=FALSE, fittingEval=TRUE, verbose=TRUE)

# compute observed signal-to-noise ratios
obsSTN <- plgem.obsStn(data=expressionset, 
                       covariate="Iron", baselineCondition="R", 
                       plgemFit=fit_30L, verbose=TRUE)

# compute resampled STN ratios
set.seed(123) 
resampledSTN <- plgem.resampledStn(data=expressionset,  
                                   covariate="Iron", baselineCondition="R", 
                                   plgemFit=fit_30L,
                                   iterations=2000, verbose=TRUE)

# compute P values 
pValues <- plgem.pValue(observedStn=obsSTN, plgemResampledStn=resampledSTN, verbose=TRUE)

# detection of differentially abundant proteins 
DEGlist <- plgem.deg(observedStn=obsSTN, plgemPval=pValues, 
                         delta=0.01, verbose=TRUE) 

# EXPORT results to directory
plgem.write.summary(DEGlist, verbose=TRUE)

# load in proteins and their p values (output from PLGEM above)
allPvalues <- read.csv("_stn_p-value.csv")
colnames(allPvalues) <- c("KO", "STN", "Pvalue")

# plot p values histogram 
allPvalues %>% 
  ggplot(aes(Pvalue)) + 
  geom_histogram(binwidth = 0.01, 
                 boundary = 0.5, 
                 fill = "darkblue",
                 colour = "white") +
  xlab("p-value") +
  ylab("Frequency") +
  labs(title = "P value distribution") +
  theme_minimal()

# make df with abundance data and p values for all proteins
data_30L30R <- merge(allPvalues, oo_30L30R, by = "KO")

# calculate log2 fold change
data_30L30R_fc <- data_30L30R[,4:9] # df to hold just abundance data for now
colnames(data_30L30R_fc) <- c("30L1_log", "30L2_log", "30L3_log", "30R1_log", "30R2_log", "30R3_log") # differentiate between log and non log data
data_30L30R_fc <- log2(data_30L30R_fc+1) # log transform
data_30L30R_fc <- cbind(data_30L30R, data_30L30R_fc) # combine log transformed data back with p values and annotations 

# calculate and add new columns for average abundances, log2 fold change, and -log10Pvalue
data_30L30R_fc$Pvalue[data_30L30R_fc$Pvalue == 0] <- 0.000001 # so it doesn't calculate "inf" for -log10Pvalue

data_30L30R_fc <- data_30L30R_fc %>% 
  dplyr::group_by(KO) %>% 
  dplyr::mutate(mean_control = mean(c(`30R1`, `30R2`, `30R3`)),
                mean_treatment= mean(c(`30L1`, `30L2`, `30L3`)),
                mean_control_log = mean(c(`30R1_log`, `30R2_log`, `30R3_log`)),
                mean_treatment_log= mean(c(`30L1_log`, `30L2_log`, `30L3_log`)),
                log_fc = mean_treatment_log - mean_control_log,
                log_pval = -1*log10(Pvalue),
                Expression = case_when(log_fc >= 1 && log_pval >= 2 ~ 'Upregulated',
                                       log_fc <= -1 && log_pval >=2 ~ 'Downregulated',
                                       TRUE ~ 'Unchanged'))

# filter significant DAPs 
data_30L30R_DAPs <- data_30L30R_fc %>%
  filter(log_pval >= 2 & (log_fc >= 1 | log_fc <= -1))  #P < 0.01 and log fc > 1 or -1 (doubling)

write.csv(data_30L30R_DAPs, "YX_30Lvs30R_DAPs_data.csv", row.names = FALSE) 
#write_xlsx(data_30L30R_DAPs, "YX_30Lvs30R_DAPs_data.xlsx")
```


**30Lvs27R (Interaction scenario)**
```{r, message=FALSE, warning=FALSE}
## load and prep data in proper format required for PLGEM
oo <- read.csv("oo_protein_data.csv", check.names = FALSE) 

oo_30L27R <- oo[,c(1,5:10,14:20)] # df with only the samples in the current pairwise comparison
oo_30L27R <- oo_30L27R[rowSums(oo_30L27R[,2:7])>0,] # remove proteins that have 0 abundance across all samples in pairwise comparison

# exprsFile
exprsFile <- oo_30L27R[,c(1:7)] # select KO and all sample columns only
row.names(exprsFile) <- exprsFile$KO # KOs as row names
exprsFile$KO <- NULL

# exprs
exprs <- as.matrix(exprsFile) # convert to matrix 

# p data
pData <- read.csv("Pdata_PLGEM.csv")
pData <- pData[c(4:9),] # include only samples in pairwise comparison
pData$Temperature <- as.character(pData$Temperature)
row.names(pData) <- pData$Sample # samples as rows
pData$Sample <- NULL

all(rownames(pData)==colnames(exprs)) # check

# put files in right format for model building
experimentData <- new("MIAME", name="Cara Schiksnis", lab="Hutchins Lab", 
                      title="YX04-1 Warming/ Fe Limitation", abstract="Proteomics analysis using PLGEM")
phenoData <- new("AnnotatedDataFrame", data=pData) 
expressionset <- ExpressionSet(assayData=exprs, phenoData=phenoData, experimentData=experimentData)

## model building
fit_30L <- plgem.fit(data=expressionset, covariate="Iron", fitCondition="L", 
                     p=10, q=0.5, trimAllZeroRows=TRUE, zeroMeanOrSD="trim", 
                     plot.file=FALSE, fittingEval=TRUE, verbose=TRUE)

fit_27R <- plgem.fit(data=expressionset, covariate="Iron", fitCondition="R", 
                     p=10, q=0.5, trimAllZeroRows=TRUE, zeroMeanOrSD="trim", 
                     plot.file=FALSE, fittingEval=TRUE, verbose=TRUE)

# compute observed signal-to-noise ratios
obsSTN <- plgem.obsStn(data=expressionset, 
                       covariate="Iron", baselineCondition="R", 
                       plgemFit=fit_30L, verbose=TRUE)

# compute resampled STN ratios
set.seed(123) 
resampledSTN <- plgem.resampledStn(data=expressionset,  
                                   covariate="Iron", baselineCondition="R", 
                                   plgemFit=fit_30L,
                                   iterations=2000, verbose=TRUE)

# compute P values 
pValues <- plgem.pValue(observedStn=obsSTN, plgemResampledStn=resampledSTN, verbose=TRUE)

# detection of differentially abundant proteins 
DEGlist <- plgem.deg(observedStn=obsSTN, plgemPval=pValues, 
                         delta=0.01, verbose=TRUE) 

# EXPORT results to directory
plgem.write.summary(DEGlist, verbose=TRUE)

# load in proteins and their p values (output from PLGEM above)
allPvalues <- read.csv("_stn_p-value.csv")
colnames(allPvalues) <- c("KO", "STN", "Pvalue")

# plot p values histogram 
allPvalues %>% 
  ggplot(aes(Pvalue)) + 
  geom_histogram(binwidth = 0.01, 
                 boundary = 0.5, 
                 fill = "darkblue",
                 colour = "white") +
  xlab("p-value") +
  ylab("Frequency") +
  labs(title = "P value distribution") +
  theme_minimal()

# make df with abundance data and p values for all proteins
data_30L <- merge(allPvalues, oo_30L27R, by = "KO")

# calculate log2 fold change
data_30L_fc <- data_30L[,4:9] # df to hold just abundance data for now
colnames(data_30L_fc) <- c("30L1_log", "30L2_log", "30L3_log", "27R1_log", "27R2_log", "27R3_log") # differentiate between log and non log data
data_30L_fc <- log2(data_30L_fc+1) # log transform
data_30L_fc <- cbind(data_30L, data_30L_fc) # combine log transformed data back with p values and annotations 

# calculate and add new columns for average abundances, log2 fold change, and -log10Pvalue
data_30L_fc$Pvalue[data_30L_fc$Pvalue == 0] <- 0.000001 # so it doesn't calculate "inf" for -log10Pvalue

data_30L_fc <- data_30L_fc %>% 
  dplyr::group_by(KO) %>% 
  dplyr::mutate(mean_control = mean(c(`27R1`, `27R2`, `27R3`)),
                mean_treatment= mean(c(`30L1`, `30L2`, `30L3`)),
                mean_control_log = mean(c(`27R1_log`, `27R2_log`, `27R3_log`)),
                mean_treatment_log= mean(c(`30L1_log`, `30L2_log`, `30L3_log`)),
                log_fc = mean_treatment_log - mean_control_log,
                log_pval = -1*log10(Pvalue),
                Expression = case_when(log_fc >= 1 && log_pval >= 2 ~ 'Upregulated',
                                       log_fc <= -1 && log_pval >=2 ~ 'Downregulated',
                                       TRUE ~ 'Unchanged'))


# filter significant DAPs 
data_30L_DAPs <- data_30L_fc %>%
  filter(log_pval >= 2 & (log_fc >= 1 | log_fc <= -1))  #P < 0.01 and log fc > 1 or -1 (doubling)

write.csv(data_30L_DAPs, "YX_30Lvs27R_DAPs_data.csv", row.names = FALSE) 
#write_xlsx(data_30L_DAPs, "YX_30Lvs27R_DAPs_data.xlsx")
```


**30Rvs27R (Warming under replete Fe)**
```{r, message=FALSE, warning=FALSE}
## load and prep data in proper format required for PLGEM
oo <- read.csv("oo_protein_data.csv", check.names = FALSE) 

oo_30R27R <- oo[,c(1,8:20)] # df with only samples in the current pairwise comparison
oo_30R27R <- oo_30R27R[rowSums(oo_30R27R[,2:7])>0,] # remove proteins that have 0 abundance across all samples in pairwise comparison

# exprsFile
exprsFile <- oo_30R27R[,c(1:7)] # select KO and all sample columns only
row.names(exprsFile) <- exprsFile$KO # KOs as row names
exprsFile$KO <- NULL

# exprs
exprs <- as.matrix(exprsFile) # convert to matrix 

# p data
pData <- read.csv("Pdata_PLGEM.csv")
pData <- pData[c(7:12),] # include only samples in pairwise comparison
pData$Temperature <- as.character(pData$Temperature)
row.names(pData) <- pData$Sample # samples as rows
pData$Sample <- NULL

all(rownames(pData)==colnames(exprs)) # check

# put files in right format for model building
experimentData <- new("MIAME", name="Cara Schiksnis", lab="Hutchins Lab", 
                      title="YX04-1 Warming/ Fe Limitation", abstract="Proteomics analysis using PLGEM")
phenoData <- new("AnnotatedDataFrame", data=pData) 
expressionset <- ExpressionSet(assayData=exprs, phenoData=phenoData, experimentData=experimentData)

## model building
fit_30R <- plgem.fit(data=expressionset, covariate="Temperature", fitCondition="30", 
                     p=10, q=0.5, trimAllZeroRows=TRUE, zeroMeanOrSD="trim", 
                     plot.file=FALSE, fittingEval=TRUE, verbose=TRUE)

fit_27R <- plgem.fit(data=expressionset, covariate="Temperature", fitCondition="27", 
                     p=10, q=0.5, trimAllZeroRows=TRUE, zeroMeanOrSD="trim", 
                     plot.file=FALSE, fittingEval=TRUE, verbose=TRUE)

# compute observed signal-to-noise ratios
obsSTN <- plgem.obsStn(data=expressionset, 
                       covariate="Temperature", baselineCondition="27", 
                       plgemFit=fit_30R, verbose=TRUE)

# compute resampled STN ratios
set.seed(123) 
resampledSTN <- plgem.resampledStn(data=expressionset,  
                                   covariate="Temperature", baselineCondition="27", 
                                   plgemFit=fit_30R,
                                   iterations=2000, verbose=TRUE)

# compute P values 
pValues <- plgem.pValue(observedStn=obsSTN, plgemResampledStn=resampledSTN, verbose=TRUE)

# detection of differentially abundant proteins 
DEGlist <- plgem.deg(observedStn=obsSTN, plgemPval=pValues, 
                         delta=0.01, verbose=TRUE) 

# EXPORT results to directory
plgem.write.summary(DEGlist, verbose=TRUE)

# load in proteins and their p values (output from PLGEM above)
allPvalues <- read.csv("_stn_p-value.csv")
colnames(allPvalues) <- c("KO", "STN", "Pvalue")

# plot p values histogram 
allPvalues %>% 
  ggplot(aes(Pvalue)) + 
  geom_histogram(binwidth = 0.01, 
                 boundary = 0.5, 
                 fill = "darkblue",
                 colour = "white") +
  xlab("p-value") +
  ylab("Frequency") +
  labs(title = "P value distribution") +
  theme_minimal()

# make df with abundance data and p values for all proteins
data_30R27R <- merge(allPvalues, oo_30R27R, by = "KO")

# calculate log2 fold change
data_30R27R_fc <- data_30R27R[,4:9] # df to hold just abundance data for now
colnames(data_30R27R_fc) <- c("27R1_log", "27R2_log", "27R3_log", "30R1_log", "30R2_log", "30R3_log") # differentiate between log and non log data
data_30R27R_fc <- log2(data_30R27R_fc+1) # log transform
data_30R27R_fc <- cbind(data_30R27R, data_30R27R_fc) # combine log transformed data back with p values and annotations 

# calculate and add new columns for average abundances, log2 fold change, and -log10Pvalue
data_30R27R_fc$Pvalue[data_30R27R_fc$Pvalue == 0] <- 0.000001 # so it doesn't calculate "inf" for -log10Pvalue

data_30R27R_fc <- data_30R27R_fc %>% 
  dplyr::group_by(KO) %>% 
  dplyr::mutate(mean_control = mean(c(`27R1`, `27R2`, `27R3`)),
                mean_treatment= mean(c(`30R1`, `30R2`, `30R3`)),
                mean_control_log = mean(c(`27R1_log`, `27R2_log`, `27R3_log`)),
                mean_treatment_log= mean(c(`30R1_log`, `30R2_log`, `30R3_log`)),
                log_fc = mean_treatment_log - mean_control_log,
                log_pval = -1*log10(Pvalue),
                Expression = case_when(log_fc >= 1 && log_pval >= 2 ~ 'Upregulated',
                                       log_fc <= -1 && log_pval >=2 ~ 'Downregulated',
                                       TRUE ~ 'Unchanged'))


# filter significant DAPs 
data_30R27R_DAPs <- data_30R27R_fc %>%
  filter(log_pval >= 2 & (log_fc >= 1 | log_fc <= -1))  #P < 0.01 and log fc > 1 or -1 (doubling)

write.csv(data_30R27R_DAPs, "YX_30Rvs27R_DAPs_data.csv", row.names = FALSE) 
#write_xlsx(data_30R27R_DAPs, "YX_30Rvs27R_DAPs_data.xlsx")
```


**30Lvs27L (Warming under limited Fe)**
```{r, message=FALSE, warning=FALSE}
## load and prep data in proper format required for PLGEM
oo <- read.csv("oo_protein_data.csv", check.names = FALSE) 

oo_30L27L <- oo[,c(1:7,14:20)] # df with only samples in the current pairwise comparison
oo_30L27L <- oo_30L27L[rowSums(oo_30L27L[,2:7])>0,] # remove proteins that have 0 abundance across all samples in pairwise comparison

# exprsFile
exprsFile <- oo_30L27L[,c(1:7)] # select KO and all sample columns only
row.names(exprsFile) <- exprsFile$KO # KOs as row names
exprsFile$KO <- NULL

# exprs
exprs <- as.matrix(exprsFile) # convert to matrix 

# p data
pData <- read.csv("Pdata_PLGEM.csv")
pData <- pData[c(1:6),] # include only samples of interest
pData$Temperature <- as.character(pData$Temperature)
row.names(pData) <- pData$Sample # samples as rows
pData$Sample <- NULL

all(rownames(pData)==colnames(exprs)) # check

# put files in right format for model building
experimentData <- new("MIAME", name="Cara Schiksnis", lab="Hutchins Lab", 
                      title="YX04-1 Warming/ Fe Limitation", abstract="Proteomics analysis using PLGEM")
phenoData <- new("AnnotatedDataFrame", data=pData) 
expressionset <- ExpressionSet(assayData=exprs, phenoData=phenoData, experimentData=experimentData)

## model building
fit_30L <- plgem.fit(data=expressionset, covariate="Temperature", fitCondition="30", 
                     p=10, q=0.5, trimAllZeroRows=TRUE, zeroMeanOrSD="trim", 
                     plot.file=FALSE, fittingEval=TRUE, verbose=TRUE)

fit_27L <- plgem.fit(data=expressionset, covariate="Temperature", fitCondition="27", 
                     p=10, q=0.5, trimAllZeroRows=TRUE, zeroMeanOrSD="trim", 
                     plot.file=FALSE, fittingEval=TRUE, verbose=TRUE)

# compute observed signal-to-noise ratios
obsSTN <- plgem.obsStn(data=expressionset, 
                       covariate="Temperature", baselineCondition="27", 
                       plgemFit=fit_30L, verbose=TRUE)

# compute resampled STN ratios
set.seed(123) 
resampledSTN <- plgem.resampledStn(data=expressionset,  
                                   covariate="Temperature", baselineCondition="27", 
                                   plgemFit=fit_30L,
                                   iterations=2000, verbose=TRUE)

# compute P values 
pValues <- plgem.pValue(observedStn=obsSTN, plgemResampledStn=resampledSTN, verbose=TRUE)

# detection of differentially abundant proteins 
DEGlist <- plgem.deg(observedStn=obsSTN, plgemPval=pValues, 
                         delta=0.01, verbose=TRUE) 

# EXPORT results to directory
plgem.write.summary(DEGlist, verbose=TRUE)

# load in proteins and their p values (output from PLGEM above)
allPvalues <- read.csv("_stn_p-value.csv")
colnames(allPvalues) <- c("KO", "STN", "Pvalue")

# plot p values histogram 
allPvalues %>% 
  ggplot(aes(Pvalue)) + 
  geom_histogram(binwidth = 0.01, 
                 boundary = 0.5, 
                 fill = "darkblue",
                 colour = "white") +
  xlab("p-value") +
  ylab("Frequency") +
  labs(title = "P value distribution") +
  theme_minimal()

# make df with abundance data and p values for all proteins
data_30L27L <- merge(allPvalues, oo_30L27L, by = "KO")

# calculate log2 fold change
data_30L27L_fc <- data_30L27L[,4:9] # df to hold just abundance data for now
colnames(data_30L27L_fc) <- c("27L1_log", "27L2_log", "27L3_log", "30L1_log", "30L2_log", "30L3_log") # differentiate between log and non log data
data_30L27L_fc <- log2(data_30L27L_fc+1) # log transform
data_30L27L_fc <- cbind(data_30L27L, data_30L27L_fc) # combine log transformed data back with p values and annotations 

# calculate and add new columns for average abundances, log2 fold change, and -log10Pvalue
data_30L27L_fc$Pvalue[data_30L27L_fc$Pvalue == 0] <- 0.000001 # so it doesn't calculate "inf" for -log10Pvalue

data_30L27L_fc <- data_30L27L_fc %>% 
  dplyr::group_by(KO) %>% 
  dplyr::mutate(mean_control = mean(c(`27L1`, `27L2`, `27L3`)),
                mean_treatment= mean(c(`30L1`, `30L2`, `30L3`)),
                mean_control_log = mean(c(`27L1_log`, `27L2_log`, `27L3_log`)),
                mean_treatment_log= mean(c(`30L1_log`, `30L2_log`, `30L3_log`)),
                log_fc = mean_treatment_log - mean_control_log,
                log_pval = -1*log10(Pvalue),
                Expression = case_when(log_fc >= 1 && log_pval >= 2 ~ 'Upregulated',
                                       log_fc <= -1 && log_pval >=2 ~ 'Downregulated',
                                       TRUE ~ 'Unchanged'))


# filter significant DAPs 
data_30L27L_DAPs <- data_30L27L_fc %>%
  filter(log_pval >= 2 & (log_fc >= 1 | log_fc <= -1))  #P < 0.01 and log fc > 1 or -1 (doubling)

write.csv(data_30L27L_DAPs, "YX_30Lvs27L_DAPs_data.csv", row.names = FALSE)
#write_xlsx(data_30L27L_DAPs, "YX_30Lvs27L_DAPs_data.xlsx")
```

#### XM-24:

**27Lvs27R (Fe limitation at thermal optimum)**
```{r, message=FALSE, warning=FALSE}
## load and prep data in proper format required for PLGEM
co <- read.csv("co_protein_data.csv", check.names = FALSE)

co_27L27R <- co[,c(1:4,8:10,14:20)] # df with only the samples in the current pairwise comparison
co_27L27R <- co_27L27R[rowSums(co_27L27R[,2:7])>0,] # remove proteins that have 0 abundance across all samples in pairwise comparison

# exprsFile
exprsFile <- co_27L27R[,c(1:7)] # select KO and all sample columns 
row.names(exprsFile) <- exprsFile$KO # KOs as row names
exprsFile$KO <- NULL

# exprs
exprs <- as.matrix(exprsFile) # convert to matrix 

# p data
pData <- read.csv("Pdata_PLGEM.csv")
pData <- pData[c(1:3,7:9),] # include only samples in pairwise comparison
pData$Temperature <- as.character(pData$Temperature)
row.names(pData) <- pData$Sample # samples as rows
pData$Sample <- NULL

all(rownames(pData)==colnames(exprs)) # check

# put files in right format for model building
experimentData <- new("MIAME", name="Cara Schiksnis", lab="Hutchins Lab", 
                      title="XM-24 Warming/ Fe Limitation", abstract="Proteomics analysis using PLGEM")
phenoData <- new("AnnotatedDataFrame", data=pData) 
expressionset <- ExpressionSet(assayData=exprs, phenoData=phenoData, experimentData=experimentData)

## model building
fit_27L <- plgem.fit(data=expressionset, covariate="Iron", fitCondition="L", 
                     p=10, q=0.5, trimAllZeroRows=TRUE, zeroMeanOrSD="trim", 
                     plot.file=FALSE, fittingEval=TRUE, verbose=TRUE)

fit_27R <- plgem.fit(data=expressionset, covariate="Iron", fitCondition="R", 
                     p=10, q=0.5, trimAllZeroRows=TRUE, zeroMeanOrSD="trim", 
                     plot.file=FALSE, fittingEval=TRUE, verbose=TRUE)

# compute observed signal-to-noise ratios
obsSTN <- plgem.obsStn(data=expressionset, 
                       covariate="Iron", baselineCondition="R", 
                       plgemFit=fit_27R, verbose=TRUE)

# compute resampled STN ratios
set.seed(123) 
resampledSTN <- plgem.resampledStn(data=expressionset,  
                                   covariate="Iron", baselineCondition="R", 
                                   plgemFit=fit_27R,
                                   iterations=2000, verbose=TRUE)

# compute P values 
pValues <- plgem.pValue(observedStn=obsSTN, plgemResampledStn=resampledSTN, verbose=TRUE)

# detection of differentially abundant proteins 
DEGlist <- plgem.deg(observedStn=obsSTN, plgemPval=pValues, 
                         delta=0.01, verbose=TRUE) 

# EXPORT results to directory
plgem.write.summary(DEGlist, verbose=TRUE)

# load in proteins and their p values (output from PLGEM above)
allPvalues <- read.csv("_stn_p-value.csv")
colnames(allPvalues) <- c("KO", "STN", "Pvalue")

# plot p values histogram 
allPvalues %>% 
  ggplot(aes(Pvalue)) + 
  geom_histogram(binwidth = 0.01, 
                 boundary = 0.5, 
                 fill = "darkblue",
                 colour = "white") +
  xlab("p-value") +
  ylab("Frequency") +
  labs(title = "P value distribution") +
  theme_minimal()

# make df with abundance data and p values for all proteins
data_27L <- merge(allPvalues, co_27L27R, by = "KO")

# calculate log2 fold change
data_27L_fc <- data_27L[,4:9] # df to hold just abundance data for now
colnames(data_27L_fc) <- c("27L1_log", "27L2_log", "27L3_log", "27R1_log", "27R2_log", "27R3_log") # differentiate between log and non log data
data_27L_fc <- log2(data_27L_fc+1) # log transform
data_27L_fc <- cbind(data_27L, data_27L_fc) # combine log transformed data back with p values and annotations 

# calculate and add new columns for average abundances, log2 fold change, and -log10Pvalue
data_27L_fc$Pvalue[data_27L_fc$Pvalue == 0] <- 0.000001 # so it doesn't calculate "inf" for -log10Pvalue

data_27L_fc <- data_27L_fc %>% 
  dplyr::group_by(KO) %>% 
  dplyr::mutate(mean_control = mean(c(`27R1`, `27R2`, `27R3`)),
                mean_treatment= mean(c(`27L1`, `27L2`, `27L3`)),
                mean_control_log = mean(c(`27R1_log`, `27R2_log`, `27R3_log`)),
                mean_treatment_log= mean(c(`27L1_log`, `27L2_log`, `27L3_log`)),
                log_fc = mean_treatment_log - mean_control_log,
                log_pval = -1*log10(Pvalue),
                Expression = case_when(log_fc >= 1 && log_pval >= 2 ~ 'Upregulated',
                                       log_fc <= -1 && log_pval >=2 ~ 'Downregulated',
                                       TRUE ~ 'Unchanged'))

# filter significant DAPs 
data_27L_DAPs <- data_27L_fc %>%
  filter(log_pval >= 2 & (log_fc >= 1 | log_fc <= -1))  #P < 0.01 and log fc > 1 or -1 (doubling)

write.csv(data_27L_DAPs, "XM_27Lvs27R_DAPs_data.csv", row.names = FALSE) 
#write_xlsx(data_27L_DAPs, "XM_27Lvs27R_DAPs_data.xlsx")
```


**30Lvs30R (Fe limitation at supra optimum temperature)**
```{r, message=FALSE, warning=FALSE}
## load and prep data in proper format required for PLGEM
co <- read.csv("co_protein_data.csv", check.names = FALSE) 

co_30L30R <- co[,c(1,5:7,11:13,14:20)] # df with only samples in the current pairwise comparison
co_30L30R <- co_30L30R[rowSums(co_30L30R[,2:7])>0,] # remove proteins that have 0 abundance across all samples in pairwise comparison

# exprsFile
exprsFile <- co_30L30R[,c(1:7)] # select KO and all sample columns only
row.names(exprsFile) <- exprsFile$KO # KOs as row names
exprsFile$KO <- NULL

# exprs
exprs <- as.matrix(exprsFile) # convert to matrix 

# p data
pData <- read.csv("Pdata_PLGEM.csv")
pData <- pData[c(4:6,10:12),] # include only samples in pairwise comparison
pData$Temperature <- as.character(pData$Temperature)
row.names(pData) <- pData$Sample # samples as rows
pData$Sample <- NULL

all(rownames(pData)==colnames(exprs)) # check

# put files in right format for model building
experimentData <- new("MIAME", name="Cara Schiksnis", lab="Hutchins Lab", 
                      title="XM-24 Warming/ Fe Limitation", abstract="Proteomics analysis using PLGEM")
phenoData <- new("AnnotatedDataFrame", data=pData) 
expressionset <- ExpressionSet(assayData=exprs, phenoData=phenoData, experimentData=experimentData)

## model building
fit_30L <- plgem.fit(data=expressionset, covariate="Iron", fitCondition="L", 
                     p=10, q=0.5, trimAllZeroRows=TRUE, zeroMeanOrSD="trim", 
                     plot.file=FALSE, fittingEval=TRUE, verbose=TRUE)

fit_30R <- plgem.fit(data=expressionset, covariate="Iron", fitCondition="R", 
                     p=10, q=0.5, trimAllZeroRows=TRUE, zeroMeanOrSD="trim", 
                     plot.file=FALSE, fittingEval=TRUE, verbose=TRUE)

# compute observed signal-to-noise ratios
obsSTN <- plgem.obsStn(data=expressionset, 
                       covariate="Iron", baselineCondition="R", 
                       plgemFit=fit_30R, verbose=TRUE)

# compute resampled STN ratios
set.seed(123) 
resampledSTN <- plgem.resampledStn(data=expressionset,  
                                   covariate="Iron", baselineCondition="R", 
                                   plgemFit=fit_30R,
                                   iterations=2000, verbose=TRUE)

# compute P values 
pValues <- plgem.pValue(observedStn=obsSTN, plgemResampledStn=resampledSTN, verbose=TRUE)

# detection of differentially abundant proteins 
DEGlist <- plgem.deg(observedStn=obsSTN, plgemPval=pValues, 
                         delta=0.01, verbose=TRUE) 

# EXPORT results to directory
plgem.write.summary(DEGlist, verbose=TRUE)

# load in proteins and their p values (output from PLGEM above)
allPvalues <- read.csv("_stn_p-value.csv")
colnames(allPvalues) <- c("KO", "STN", "Pvalue")

# plot p values histogram 
allPvalues %>% 
  ggplot(aes(Pvalue)) + 
  geom_histogram(binwidth = 0.01, 
                 boundary = 0.5, 
                 fill = "darkblue",
                 colour = "white") +
  xlab("p-value") +
  ylab("Frequency") +
  labs(title = "P value distribution") +
  theme_minimal()

# make df with abundance data and p values for all proteins
data_30L30R <- merge(allPvalues, co_30L30R, by = "KO")

# calculate log2 fold change
data_30L30R_fc <- data_30L30R[,4:9] # df to hold just abundance data for now
colnames(data_30L30R_fc) <- c("30L1_log", "30L2_log", "30L3_log", "30R1_log", "30R2_log", "30R3_log") # differentiate between log and non log data
data_30L30R_fc <- log2(data_30L30R_fc+1) # log transform
data_30L30R_fc <- cbind(data_30L30R, data_30L30R_fc) # combine log transformed data back with p values and annotations 

# calculate and add new columns for average abundances, log2 fold change, and -log10Pvalue
data_30L30R_fc$Pvalue[data_30L30R_fc$Pvalue == 0] <- 0.000001 # so it doesn't calculate "inf" for -log10Pvalue

data_30L30R_fc <- data_30L30R_fc %>% 
  dplyr::group_by(KO) %>% 
  dplyr::mutate(mean_control = mean(c(`30R1`, `30R2`, `30R3`)),
                mean_treatment= mean(c(`30L1`, `30L2`, `30L3`)),
                mean_control_log = mean(c(`30R1_log`, `30R2_log`, `30R3_log`)),
                mean_treatment_log= mean(c(`30L1_log`, `30L2_log`, `30L3_log`)),
                log_fc = mean_treatment_log - mean_control_log,
                log_pval = -1*log10(Pvalue),
                Expression = case_when(log_fc >= 1 && log_pval >= 2 ~ 'Upregulated',
                                       log_fc <= -1 && log_pval >=2 ~ 'Downregulated',
                                       TRUE ~ 'Unchanged'))

# filter significant DAPs 
data_30L30R_DAPs <- data_30L30R_fc %>%
  filter(log_pval >= 2 & (log_fc >= 1 | log_fc <= -1))  #P < 0.01 and log fc > 1 or -1 (doubling)

write.csv(data_30L30R_DAPs, "XM_30Lvs30R_DAPs_data.csv", row.names = FALSE) 
#write_xlsx(data_30L30R_DAPs, "XM_30Lvs30R_DAPs_data.xlsx")
```

**30Lvs27R (Interaction scenario)**
```{r, message=FALSE, warning=FALSE}
## load and prep data in proper format required for PLGEM
co <- read.csv("co_protein_data.csv", check.names = FALSE) 

co_30L27R <- co[,c(1,5:10,14:20)] # df with only the samples in the current pairwise comparison
co_30L27R <- co_30L27R[rowSums(co_30L27R[,2:7])>0,] # remove proteins that have 0 abundance across all samples in pairwise comparison

# exprsFile
exprsFile <- co_30L27R[,c(1:7)] # select KO and all sample columns 
row.names(exprsFile) <- exprsFile$KO # KOs as row names
exprsFile$KO <- NULL

# exprs
exprs <- as.matrix(exprsFile) # convert to matrix 

# p data
pData <- read.csv("Pdata_PLGEM.csv")
pData <- pData[c(4:9),] # include only samples in pairwise comparison
pData$Temperature <- as.character(pData$Temperature)
row.names(pData) <- pData$Sample # samples as rows
pData$Sample <- NULL

all(rownames(pData)==colnames(exprs)) # check

# put files in right format for model building
experimentData <- new("MIAME", name="Cara Schiksnis", lab="Hutchins Lab", 
                      title="XM-24 Warming/ Fe Limitation", abstract="Proteomics analysis using PLGEM")
phenoData <- new("AnnotatedDataFrame", data=pData) 
expressionset <- ExpressionSet(assayData=exprs, phenoData=phenoData, experimentData=experimentData)

## model building
fit_30L <- plgem.fit(data=expressionset, covariate="Iron", fitCondition="L", 
                     p=10, q=0.5, trimAllZeroRows=TRUE, zeroMeanOrSD="trim", 
                     plot.file=FALSE, fittingEval=TRUE, verbose=TRUE)

fit_27R <- plgem.fit(data=expressionset, covariate="Iron", fitCondition="R", 
                     p=10, q=0.5, trimAllZeroRows=TRUE, zeroMeanOrSD="trim", 
                     plot.file=FALSE, fittingEval=TRUE, verbose=TRUE)

# compute observed signal-to-noise ratios
obsSTN <- plgem.obsStn(data=expressionset, 
                       covariate="Iron", baselineCondition="R", 
                       plgemFit=fit_27R, verbose=TRUE)

# compute resampled STN ratios
set.seed(123) 
resampledSTN <- plgem.resampledStn(data=expressionset,  
                                   covariate="Iron", baselineCondition="R", 
                                   plgemFit=fit_27R,
                                   iterations=2000, verbose=TRUE)

# compute P values 
pValues <- plgem.pValue(observedStn=obsSTN, plgemResampledStn=resampledSTN, verbose=TRUE)

# detection of differentially abundant proteins 
DEGlist <- plgem.deg(observedStn=obsSTN, plgemPval=pValues, 
                         delta=0.01, verbose=TRUE) 

# EXPORT results to directory
plgem.write.summary(DEGlist, verbose=TRUE)

# load in proteins and their p values (output from PLGEM above)
allPvalues <- read.csv("_stn_p-value.csv")
colnames(allPvalues) <- c("KO", "STN", "Pvalue")

# plot p values histogram 
allPvalues %>% 
  ggplot(aes(Pvalue)) + 
  geom_histogram(binwidth = 0.01, 
                 boundary = 0.5, 
                 fill = "darkblue",
                 colour = "white") +
  xlab("p-value") +
  ylab("Frequency") +
  labs(title = "P value distribution") +
  theme_minimal()

# make df with KOs, abundance data, and p values for all proteins
data_30L <- merge(allPvalues, co_30L27R, by = "KO")

# calculate log2 fold change
data_30L_fc <- data_30L[,4:9] # df to hold just abundance data for now
colnames(data_30L_fc) <- c("30L1_log", "30L2_log", "30L3_log", "27R1_log", "27R2_log", "27R3_log") # differentiate between log and non log data
data_30L_fc <- log2(data_30L_fc+1) # log transform
data_30L_fc <- cbind(data_30L, data_30L_fc) # combine log transformed data back with p values and annotations 

# calculate and add new columns for average abundances, log2 fold change, and -log10Pvalue
data_30L_fc$Pvalue[data_30L_fc$Pvalue == 0] <- 0.000001 # so it doesn't calculate "inf" for -log10Pvalue

data_30L_fc <- data_30L_fc %>% 
  dplyr::group_by(KO) %>% 
  dplyr::mutate(mean_control = mean(c(`27R1`, `27R2`, `27R3`)),
                mean_treatment= mean(c(`30L1`, `30L2`, `30L3`)),
                mean_control_log = mean(c(`27R1_log`, `27R2_log`, `27R3_log`)),
                mean_treatment_log= mean(c(`30L1_log`, `30L2_log`, `30L3_log`)),
                log_fc = mean_treatment_log - mean_control_log,
                log_pval = -1*log10(Pvalue),
                Expression = case_when(log_fc >= 1 && log_pval >= 2 ~ 'Upregulated',
                                       log_fc <= -1 && log_pval >=2 ~ 'Downregulated',
                                       TRUE ~ 'Unchanged'))


# filter significant DAPs 
data_30L_DAPs <- data_30L_fc %>%
  filter(log_pval >= 2 & (log_fc >= 1 | log_fc <= -1))  #P < 0.01 and log fc > 1 or -1 (doubling)

write.csv(data_30L_DAPs, "XM_30Lvs27R_DAPs_data.csv", row.names = FALSE) 
#write_xlsx(data_30L_DAPs, "XM_30Lvs27R_DAPs_data.xlsx")
```


**30Rvs27R (Warming under replete Fe)**
```{r, message=FALSE, warning=FALSE}
## load and prep data in proper format required for PLGEM
co <- read.csv("co_protein_data.csv", check.names = FALSE) 

co_30R27R <- co[,c(1,8:20)] # df with only the samples in the current pairwise comparison
co_30R27R <- co_30R27R[rowSums(co_30R27R[,2:7])>0,] # remove proteins that have 0 abundance across all samples in pairwise comparison

# exprsFile
exprsFile <- co_30R27R[,c(1:7)] # select KO and all sample columns
row.names(exprsFile) <- exprsFile$KO # KOs as row names
exprsFile$KO <- NULL

# exprs
exprs <- as.matrix(exprsFile) # convert to matrix

# p data
pData <- read.csv("Pdata_PLGEM.csv")
pData <- pData[c(7:12),] # include only samples in pairwise comparison
pData$Temperature <- as.character(pData$Temperature)
row.names(pData) <- pData$Sample # samples as rows
pData$Sample <- NULL

all(rownames(pData)==colnames(exprs)) # check

# put files in right format for model building
experimentData <- new("MIAME", name="Cara Schiksnis", lab="Hutchins Lab", 
                      title="XM-24 Warming/ Fe Limitation", abstract="Proteomics analysis using PLGEM")
phenoData <- new("AnnotatedDataFrame", data=pData) 
expressionset <- ExpressionSet(assayData=exprs, phenoData=phenoData, experimentData=experimentData)

## model building
fit_30R <- plgem.fit(data=expressionset, covariate="Temperature", fitCondition="30", 
                     p=10, q=0.5, trimAllZeroRows=TRUE, zeroMeanOrSD="trim", 
                     plot.file=FALSE, fittingEval=TRUE, verbose=TRUE)

fit_27R <- plgem.fit(data=expressionset, covariate="Temperature", fitCondition="27", 
                     p=10, q=0.5, trimAllZeroRows=TRUE, zeroMeanOrSD="trim", 
                     plot.file=FALSE, fittingEval=TRUE, verbose=TRUE)

# compute observed signal-to-noise ratios
obsSTN <- plgem.obsStn(data=expressionset, 
                       covariate="Temperature", baselineCondition="27", 
                       plgemFit=fit_27R, verbose=TRUE)

# compute resampled STN ratios
set.seed(123) 
resampledSTN <- plgem.resampledStn(data=expressionset,  
                                   covariate="Temperature", baselineCondition="27", 
                                   plgemFit=fit_27R,
                                   iterations=2000, verbose=TRUE)

# compute P values 
pValues <- plgem.pValue(observedStn=obsSTN, plgemResampledStn=resampledSTN, verbose=TRUE)

# detection of differentially abundant proteins 
DEGlist <- plgem.deg(observedStn=obsSTN, plgemPval=pValues, 
                         delta=0.01, verbose=TRUE) 

# EXPORT results to directory
plgem.write.summary(DEGlist, verbose=TRUE)

# load in proteins and their p values (output from PLGEM above)
allPvalues <- read.csv("_stn_p-value.csv")
colnames(allPvalues) <- c("KO", "STN", "Pvalue")

# plot p values histogram 
allPvalues %>% 
  ggplot(aes(Pvalue)) + 
  geom_histogram(binwidth = 0.01, 
                 boundary = 0.5, 
                 fill = "darkblue",
                 colour = "white") +
  xlab("p-value") +
  ylab("Frequency") +
  labs(title = "P value distribution") +
  theme_minimal()

# make df with bundance data and p values for all proteins
data_30R27R <- merge(allPvalues, co_30R27R, by = "KO")

# calculate log2 fold change
data_30R27R_fc <- data_30R27R[,4:9] # df to hold just abundance data for now
colnames(data_30R27R_fc) <- c("27R1_log", "27R2_log", "27R3_log", "30R1_log", "30R2_log", "30R3_log") # differentiate between log and non log data
data_30R27R_fc <- log2(data_30R27R_fc+1) # log transform
data_30R27R_fc <- cbind(data_30R27R, data_30R27R_fc) # combine log transformed data back with p values and annotations 

# calculate and add new columns for average abundances, log2 fold change, and -log10Pvalue
data_30R27R_fc$Pvalue[data_30R27R_fc$Pvalue == 0] <- 0.000001 # so it doesn't calculate "inf" for -log10Pvalue

data_30R27R_fc <- data_30R27R_fc %>% 
  dplyr::group_by(KO) %>% 
  dplyr::mutate(mean_control = mean(c(`27R1`, `27R2`, `27R3`)),
                mean_treatment= mean(c(`30R1`, `30R2`, `30R3`)),
                mean_control_log = mean(c(`27R1_log`, `27R2_log`, `27R3_log`)),
                mean_treatment_log= mean(c(`30R1_log`, `30R2_log`, `30R3_log`)),
                log_fc = mean_treatment_log - mean_control_log,
                log_pval = -1*log10(Pvalue),
                Expression = case_when(log_fc >= 1 && log_pval >= 2 ~ 'Upregulated',
                                       log_fc <= -1 && log_pval >=2 ~ 'Downregulated',
                                       TRUE ~ 'Unchanged'))

# filter significant DAPs 
data_30R27R_DAPs <- data_30R27R_fc %>%
  filter(log_pval >= 2 & (log_fc >= 1 | log_fc <= -1))  #P < 0.01 and log fc > 1 or -1 (doubling)

write.csv(data_30R27R_DAPs, "XM_30Rvs27R_DAPs_data.csv", row.names = FALSE) 
#write_xlsx(data_30R27R_DAPs, "XM_30Rvs27R_DAPs_data.xlsx")
```


**30Lvs27L (Warming under limited Fe)**
```{r, message=FALSE, warning=FALSE}
## load and prep data in proper format required for PLGEM
co <- read.csv("co_protein_data.csv", check.names = FALSE) 

co_30L27L <- co[,c(1:7,14:20)] # df with only the samples in the current pairwise comparison
co_30L27L <- co_30L27L[rowSums(co_30L27L[,2:7])>0,] # remove proteins that have 0 abundance across all samples in pairwise comparison

# exprsFile
exprsFile <- co_30L27L[,c(1:7)] # select KO and all sample columns 
row.names(exprsFile) <- exprsFile$KO # KOs as row names
exprsFile$KO <- NULL

# exprs
exprs <- as.matrix(exprsFile) # convert to matrix 

# p data
pData <- read.csv("Pdata_PLGEM.csv")
pData <- pData[c(1:6),] # include only samples of interest
pData$Temperature <- as.character(pData$Temperature)
row.names(pData) <- pData$Sample # samples as rows
pData$Sample <- NULL

all(rownames(pData)==colnames(exprs)) # check

# put files in right format for model building
experimentData <- new("MIAME", name="Cara Schiksnis", lab="Hutchins Lab", 
                      title="XM-24 Warming/ Fe Limitation", abstract="Proteomics analysis using PLGEM")
phenoData <- new("AnnotatedDataFrame", data=pData) 
expressionset <- ExpressionSet(assayData=exprs, phenoData=phenoData, experimentData=experimentData)

## model building
fit_30L <- plgem.fit(data=expressionset, covariate="Temperature", fitCondition="30", 
                     p=10, q=0.5, trimAllZeroRows=TRUE, zeroMeanOrSD="trim", 
                     plot.file=FALSE, fittingEval=TRUE, verbose=TRUE)

fit_27L <- plgem.fit(data=expressionset, covariate="Temperature", fitCondition="27", 
                     p=10, q=0.5, trimAllZeroRows=TRUE, zeroMeanOrSD="trim", 
                     plot.file=FALSE, fittingEval=TRUE, verbose=TRUE)

# compute observed signal-to-noise ratios
obsSTN <- plgem.obsStn(data=expressionset, 
                       covariate="Temperature", baselineCondition="27", 
                       plgemFit=fit_27L, verbose=TRUE)

# compute resampled STN ratios
set.seed(123) 
resampledSTN <- plgem.resampledStn(data=expressionset,  
                                   covariate="Temperature", baselineCondition="27", 
                                   plgemFit=fit_27L,
                                   iterations=2000, verbose=TRUE)

# compute P values 
pValues <- plgem.pValue(observedStn=obsSTN, plgemResampledStn=resampledSTN, verbose=TRUE)

# detection of differentially abundant proteins 
DEGlist <- plgem.deg(observedStn=obsSTN, plgemPval=pValues, 
                         delta=0.01, verbose=TRUE) 

# EXPORT results to directory
plgem.write.summary(DEGlist, verbose=TRUE)

# load in proteins and their p values (output from PLGEM above)
allPvalues <- read.csv("_stn_p-value.csv")
colnames(allPvalues) <- c("KO", "STN", "Pvalue")

# plot p values histogram 
allPvalues %>% 
  ggplot(aes(Pvalue)) + 
  geom_histogram(binwidth = 0.01, 
                 boundary = 0.5, 
                 fill = "darkblue",
                 colour = "white") +
  xlab("p-value") +
  ylab("Frequency") +
  labs(title = "P value distribution") +
  theme_minimal()

# make df with abundance data and p values for all proteins
data_30L27L <- merge(allPvalues, co_30L27L, by = "KO")

# calculate log2 fold change
data_30L27L_fc <- data_30L27L[,4:9] # df to hold just abundance data for now
colnames(data_30L27L_fc) <- c("27L1_log", "27L2_log", "27L3_log", "30L1_log", "30L2_log", "30L3_log") # differentiate between log and non log data
data_30L27L_fc <- log2(data_30L27L_fc+1) # log transform
data_30L27L_fc <- cbind(data_30L27L, data_30L27L_fc) # combine log transformed data back with p values and annotations 

# calculate and add new columns for average abundances, log2 fold change, and -log10Pvalue
data_30L27L_fc$Pvalue[data_30L27L_fc$Pvalue == 0] <- 0.000001 # so it doesn't calculate "inf" for -log10Pvalue

data_30L27L_fc <- data_30L27L_fc %>% 
  dplyr::group_by(KO) %>% 
  dplyr::mutate(mean_control = mean(c(`27L1`, `27L2`, `27L3`)),
                mean_treatment= mean(c(`30L1`, `30L2`, `30L3`)),
                mean_control_log = mean(c(`27L1_log`, `27L2_log`, `27L3_log`)),
                mean_treatment_log= mean(c(`30L1_log`, `30L2_log`, `30L3_log`)),
                log_fc = mean_treatment_log - mean_control_log,
                log_pval = -1*log10(Pvalue),
                Expression = case_when(log_fc >= 1 && log_pval >= 2 ~ 'Upregulated',
                                       log_fc <= -1 && log_pval >=2 ~ 'Downregulated',
                                       TRUE ~ 'Unchanged'))

# filter significant DAPs 
data_30L27L_DAPs <- data_30L27L_fc %>%
  filter(log_pval >= 2 & (log_fc >= 1 | log_fc <= -1))  #P < 0.01 and log fc > 1 or -1 (doubling)

write.csv(data_30L27L_DAPs, "XM_30Lvs27L_DAPs_data.csv", row.names = FALSE) 
#write_xlsx(data_30L27L_DAPs, "XM_30Lvs27L_DAPs_data.xlsx")
```
